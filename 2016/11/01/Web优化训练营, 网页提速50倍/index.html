<!DOCTYPE html><html lang="zh-cmn-Hans"><head><meta charset="UTF-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title> Web优化训练营, 网页提速50倍 · 点我达前端博客</title><meta name="description" content="Web优化训练营, 网页提速50倍 - 点我达team"><link rel="stylesheet" href="/css/Dwd-Fe.css"><link rel="short icon" href="/favicon.ico"></head><body><div class="wrapper"><header id="menu-outer"><a href="/"><div class="logo"><img src="http://7xtb3a.com2.z0.glb.clouddn.com/icon@2x.png"></div></a><nav id="menu-inner"><a href="/">首页</a><a href="/archives">分类</a><a href="/about">关于我们</a><a href="https://github.com/dwd-fe">Github</a></nav></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="post-space"><div class="post-title"><h1>Web优化训练营, 网页提速50倍</h1><h2>by 黄乔森 on 2016-11-01</h2><h2><span>分类 </span><a class="tags-link" href="/tags/web优化/">web优化</a></h2></div></div><img src="http://7xtb3a.com2.z0.glb.clouddn.com/cover.png" class="post-back"></div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们将通过一个完整的实例, 一步步的优化加载, 渲染等各方面的体验.</p>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>首先我们先看一下项目的文件构成</p>
<p><img src="http://7xtb3a.com2.z0.glb.clouddn.com/file-structure.png" alt=""></p>
<p>这之中包含了一个基本网页的元素, js(React App), css, 还有图片.</p>
<p>相关资源见 <a href="https://github.com/joesonw/web-accelerate-example" target="_blank" rel="external">https://github.com/joesonw/web-accelerate-example</a></p>
<p>我们先来看一下来serve整个网页的部分.</p>
<p><code>server.js</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&apos;use strict&apos;;</div><div class="line">const fs = require(&apos;fs&apos;);</div><div class="line">const path = require(&apos;path&apos;);</div><div class="line">const koa = require(&apos;koa&apos;);</div><div class="line"></div><div class="line">const app = koa();</div><div class="line"></div><div class="line">app.use(function* (next) &#123;</div><div class="line">    const file = this.path.slice(1) || &apos;index.html&apos;;</div><div class="line">    try &#123;</div><div class="line">        const content = yield cb =&gt; fs.readFile(path.resolve(&apos;./dist&apos;, file), cb);</div><div class="line">        this.body = content;</div><div class="line">        this.type = path.extname(file).slice(1);</div><div class="line">        this.status = 200;</div><div class="line">    &#125; catch (e) &#123;</div><div class="line">        this.status = 404;</div><div class="line">    &#125;</div><div class="line">    yield next;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">app.listen(process.env.PORT || 3000);</div></pre></td></tr></table></figure></p>
<p>这段代码只是简单的将<code>dist</code>目录下的文件给转发一下.</p>
<p>打开网页便可以看到相关加载情况.</p>
<p><img src="http://7xtb3a.com2.z0.glb.clouddn.com/step1-2.png" alt=""></p>
<p>我们可以看到, 整个<code>app.js</code>共277kb, 在模拟3G网络的情况下(蓝色框框),每次加载需要花费999ms, 其中下载花费了911ms(红色框框).</p>
<p>接下来我们将逐步优化, 然后每次将结果进行比较.</p>
<h2 id="优化-一-—-304"><a href="#优化-一-—-304" class="headerlink" title="优化(一) — 304"></a>优化(一) — 304</h2><p>网页加载优化中最常见的就是<code>304 Not Modified</code>了, 具体机制是浏览器发起请求, headers中包含<code>If-Modified-Since</code>,(如无缓存, 则无此头字段), 服务器对比硬盘上(或内存中)文件最后修改的时间, 如果小于或等于请求的时间, 则返回304. 否则, 则返回200, 并加上<code>Last-Modified</code>字段, 告诉客户端下次请求可以尝试请求是否有缓存.</p>
<p>具体代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">app.use(function* () &#123;</div><div class="line">    const file = path.resolve(__dirname, path.resolve(&apos;dist&apos;, this.path.slice(1) || &apos;index.html&apos;));</div><div class="line">    const headers = this.headers;</div><div class="line"></div><div class="line">    let ifLastModified = this.headers[&apos;if-modified-since&apos;];</div><div class="line">    if (ifLastModified) &#123;</div><div class="line">        ifLastModified = new Date(ifLastModified);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    try &#123;</div><div class="line">        const stat = yield cb =&gt; fs.stat(file, cb);</div><div class="line">        const now = Date.now();</div><div class="line">        if (ifLastModified &amp;&amp;</div><div class="line">            file !== path.resolve(__dirname, path.resolve(&apos;dist/index.html&apos;))) &#123;</div><div class="line">            if (ifLastModified &gt;= stat.mtime) &#123;</div><div class="line">                this.status = 304;</div><div class="line">                return; </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        console.log(file)</div><div class="line">        const content = yield cb =&gt; fs.readFile(file, cb);</div><div class="line">        this.body = content;</div><div class="line">        this.type = path.extname(file).slice(1);</div><div class="line">        this.status = 200;</div><div class="line">        this.set(&apos;Last-Modified&apos;, stat.mtime);</div><div class="line"></div><div class="line">    &#125; catch (e) &#123;</div><div class="line">        this.status = 404;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>(模拟实际情况中, 首页会动态生成, 加入一些广告,追踪或个性化数据, <code>index.html</code>并未缓存)</p>
<p>最终效果:</p>
<p><img src="http://7xtb3a.com2.z0.glb.clouddn.com/step1-3.png" alt=""></p>
<p>我们可以看见, 下载时间为2ms, 可以几乎忽略掉(只有HTTP Headers), 总共的加载时间也只有了120ms, 相比之前, 整整少了 869ms. </p>
<p>但是, 我们满足了吗?</p>
<h2 id="优化-二-—-分别打包"><a href="#优化-二-—-分别打包" class="headerlink" title="优化(二) — 分别打包"></a>优化(二) — 分别打包</h2><p>我们可以注意到, 我们打包出来最终只有一个js文件, 当依赖变多后(此例中只有react和react-dom, 每次修改都导致整个js文件被重新请求.所以我们想要把不同的library(甚至是项目内部公用的代码模块)提取出来.</p>
<p>我们首先要创建一个 <code>webpack.vendors.config.js</code> 来构建这些library, 或者vendor.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">const path = require(&apos;path&apos;);</div><div class="line">const WebpackCleanupPlugin = require(&apos;webpack-cleanup-plugin&apos;);</div><div class="line">const HtmlWebpackPlugin = require(&apos;html-webpack-plugin&apos;);</div><div class="line">const webpack = require(&apos;webpack&apos;);</div><div class="line">const ExtractTextPlugin = require(&quot;extract-text-webpack-plugin&quot;);</div><div class="line"></div><div class="line">module.exports = &#123;</div><div class="line">  plugins: [</div><div class="line">    new webpack.DefinePlugin(&#123;</div><div class="line">      &apos;process.env&apos;: &#123;</div><div class="line">        NODE_ENV: &apos;&quot;production&quot;&apos;,</div><div class="line">      &#125;,</div><div class="line">    &#125;),</div><div class="line">    new webpack.optimize.OccurenceOrderPlugin(),</div><div class="line">    new webpack.optimize.UglifyJsPlugin(&#123;</div><div class="line">      compress: &#123;</div><div class="line">        warnings: false,</div><div class="line">        screw_ie8: true,</div><div class="line">        drop_console: true,</div><div class="line">        drop_debugger: true,</div><div class="line">      &#125;,</div><div class="line">    &#125;),</div><div class="line">    new webpack.DllPlugin(&#123;</div><div class="line">      path: path.resolve(__dirname, &apos;dist/vendor/[name]-manifest.json&apos;),</div><div class="line">      name: &apos;[name]&apos;,</div><div class="line">      context: &apos;.&apos;,</div><div class="line">    &#125;),</div><div class="line">  ],</div><div class="line">  devtool: &apos;hidden-source-map&apos;, </div><div class="line">  entry: &#123;</div><div class="line">    &apos;react&apos;: [&apos;react&apos;, &apos;react-dom&apos;],</div><div class="line">  &#125;,</div><div class="line">  output: &#123;</div><div class="line">    path: path.resolve(__dirname, &apos;dist/vendor&apos;),</div><div class="line">    filename: &apos;[name].js&apos;,</div><div class="line">    library: &apos;[name]&apos;,</div><div class="line">  &#125;,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>注意到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">entry: &#123;</div><div class="line">  &apos;react&apos;: [&apos;react&apos;, &apos;react-dom&apos;],</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>意味着我们可以将同一类型的包打包成一个js文件.</p>
<p>当然, 我们也要对<code>webpack.production.js</code>做一些修改.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">const dlls = fs.readdirSync(path.resolve(__dirname, &apos;dist/vendor/&apos;))</div><div class="line">              .filter(file =&gt; path.extname(file) === &apos;.js&apos;)</div><div class="line">              .map(file =&gt; path.basename(file, &apos;.js&apos;))</div><div class="line"></div><div class="line">const dllReferencePlugins = dlls</div><div class="line">  .map(dll =&gt;</div><div class="line">    new webpack.DllReferencePlugin(&#123;</div><div class="line">        context: &apos;.&apos;,</div><div class="line">        manifest: require(`./dist/vendor/$&#123;dll&#125;-manifest.json`),</div><div class="line">    &#125;)</div><div class="line">  );</div><div class="line"></div><div class="line">module.exports = &#123;</div><div class="line">  plugins: dllReferencePlugins.concat([</div><div class="line">   ...</div><div class="line">  ]),</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这, 我们将自动扫描<code>vendor</code>目录下面的文件, 自动将所有的vendor加载进来.</p>
<p>这样我们就实现了分包加载(还有一些细节的修改, 包括<code>index.html</code>, 请参见github上, <code>step-2</code>分支)</p>
<p><img src="http://7xtb3a.com2.z0.glb.clouddn.com/step2.png" alt=""><br>效果还是不错的, <code>app.js</code>单独加载只需要400多ms, 比起所有依赖一起加载要快了至少一半以上.</p>
<p>对于一般类型网站, 优化到这已经可以取得非常不错的效果了, 但是对于大型网站来说, 我们可以做的还有很多.</p>
<h2 id="优化-三-—-强制缓存"><a href="#优化-三-—-强制缓存" class="headerlink" title="优化(三) — 强制缓存"></a>优化(三) — 强制缓存</h2><p>我们可以注意到优化一种, 一个304的请求仍然花掉了100多毫秒, 对于大型网站, 资源特别多的情况, 这仍然是一个不小的开支. 那我们可以把这个省掉吗? 答案是可以的.</p>
<p>浏览器缓存当中, 还有一个特别的字段. <code>Expires</code> , 它可以指定文件的过期时间, 直到那一刻位置, 浏览器都不会再重新发起请求, 而是直接从本地缓存中读取.</p>
<p>但是, 这仍旧需要每隔一段时间去请求. 我们该如何做呢? 答案就是, 设置超长的缓存时间, 例如10年. 但是这样我们便无法更新任何内容了. 我们该如何用到这样的特性, 而又很方便的更新呢.</p>
<p>我们可以给文件名加上 <code>hash特征值</code> , 这样只有当文件内容有改动时, 才会重新加载, 而且这样适合于分布式CDN的, 非覆盖式的发布, 可以使其在引用页面(首页)已经改变的情况下(当前服务器已经发布), 才会用到新资源, 而访问到未发布的服务器时, 还是会引用老的资源, 使得发布再也不需要熬夜</p>
<p>具体细节改动见git branch step-3.</p>
<p>实现效果:<br><img src="http://7xtb3a.com2.z0.glb.clouddn.com/step3.png" alt=""><br>可以从蓝色方框出看见, 缓存已经生效, 而整体的读取时间才只有20毫秒不到.</p>
<blockquote>
<p>从原始的1000毫秒, 到现在的20毫秒, 简简单单的三个步骤便可以让你的网页加载如飞一般的体验</p>
</blockquote>
<h2 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h2><p>1.在实际生产中, 我们通常看到的是加载的CDN域名, 这是为何呢?</p>
<p><img src="http://7xtb3a.com2.z0.glb.clouddn.com/futhrer-reading.png" alt=""><br>这是因为, 一个大型的网站, 请求当中会带上很多Cookie, 有的甚至于接近1KB, 而100个图片的加载, 就是整整100KB. 通过第三方域名(不同于当前域名), 我们可以节省掉许多不必要的请求头, Cookie头. 同样达到提速的目的</p>
<p>2.还有一种情况是, 资源分布在不同的服务器上</p>
<p><img src="http://7xtb3a.com2.z0.glb.clouddn.com/futher-reading-2.png" alt=""></p>
<p>这是因为浏览器对于同一域名下资源的并行下载数量有限制.<br><img src="http://7xtb3a.com2.z0.glb.clouddn.com/browser-concurrency.jpg" alt=""></p>
<p>使用不同的资源服务器可以避开这种限制, 加大下载并发数. 但是, 这样同样带来的缓存命中率的问题, 所以还需要存储用户缓存相关的数据. 合理的利用下, 对于页面整体的加载速度还是很有好处的.</p>
<p>3.其他的方法<br>在技术飞速发展的当下, 还有很多技术都是可以对终端用户的体验带来提升的.</p>
<ul>
<li><a href="http://tech.dianwoda.com/2016/10/26/big-pipe-web-page-rendering-acceleration/" target="_blank" rel="external">BigPipe</a> + Server-Side Rendering, 加速首页加载速度</li>
<li><a href="https://www.ampproject.org/" target="_blank" rel="external">Goole AMP</a></li>
<li><a href="https://http2.github.io/faq/" target="_blank" rel="external">HTTP/2</a></li>
</ul>
<span id="return-to-top"></span><div data-thread-key="2016/11/01/Web优化训练营, 网页提速50倍/" data-title="Web优化训练营, 网页提速50倍" data-url="http://fe.dianwoda.com/2016/11/01/Web优化训练营, 网页提速50倍/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"dwd-fe"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div></article><nav id="post-pagination"><a href="/2016/11/01/JavaScript的原型和原型链的前世今生(二)/" class="next"></a></nav></div></div><div class="copyright"><small>点我达FE 版权所有 ©️点我达FE all rights reserved. powered by <a href="https://hexo.io/" target="_blank">Hexo</a>.</small></div></div><script src="/js/Dwd-Fe.js"></script></body></html>